<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Dashboard | Competitive Success</title>
    <link rel="icon" href="/success.png" type="image/png">
    <!-- Re-using video-page.css for consistent card and layout styling -->
    <style>
        /* --- "Cosmic Gold" Theme (from home.html) --- */
        :root { --primary-color: #FFC107; --primary-hover-color: #DAA520; --card-background: rgba(255, 255, 255, 0.05); --card-border-color: rgba(255, 255, 255, 0.2); --text-color: #F5F5DC; --secondary-text-color: #adb5bd; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #0a192f;
            background-image: radial-gradient(at 80% 20%, hsla(212,40%,50%,0.3) 0px, transparent 50%), radial-gradient(at 20% 80%, hsla(280,40%,50%,0.3) 0px, transparent 50%);
            margin: 0; color: var(--text-color); min-height: 100vh; background-attachment: fixed;
        }
        .main-container { padding: 2rem; max-width: 1200px; margin: auto; width: 100%; box-sizing: border-box; }
        .page-header { text-align: center; margin-bottom: 2.5rem; }
        .page-header h1 { font-size: 3rem; color: var(--primary-color); margin: 0; }
        .page-header p { font-size: 1.2rem; color: var(--secondary-text-color); }
        .back-to-home { margin-bottom: 1.5rem; }
        .back-to-home a { display: inline-block; padding: 0.5rem 1rem; background-color: var(--card-background); border: 1px solid var(--card-border-color); color: var(--primary-color); text-decoration: none; font-weight: bold; border-radius: 5px; transition: background-color 0.3s ease; }
        .back-to-home a:hover { background-color: rgba(255, 255, 255, 0.1); }
        .dashboard-section {
            margin-bottom: 3rem;
        }
        .dashboard-section h2 {
            font-size: 1.8rem;
            color: var(--primary-color);
            border-bottom: 2px solid var(--card-border-color);
            padding-bottom: 0.5rem;
            margin-bottom: 1.5rem;
        }
        .empty-state p {
            font-size: 1.1rem;
            color: var(--secondary-text-color);
            margin: 0;
        }
        .empty-state {
            background-color: transparent;
            border: 2px dashed var(--card-border-color);
            border-radius: 12px;
            padding: 2rem;
            text-align: center;
        }
        .empty-state a {
            color: var(--primary-color);
            font-weight: bold;
            text-decoration: none;
        }
        .grid-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 1.5rem; } .resource-card { background-color: var(--card-background); border: 1px solid var(--card-border-color); border-radius: 10px; box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1); backdrop-filter: blur(5px); overflow: hidden; transition: transform 0.3s ease, box-shadow 0.3s ease; display: flex; flex-direction: column; cursor: pointer; }
        .resource-card:hover { transform: translateY(-5px); box-shadow: 0 8px 25px rgba(0, 0, 0, 0.12); }
        .card-thumbnail { width: 100%; height: 140px; background-color: #000; position: relative; overflow: hidden; } .card-thumbnail img { width: 100%; height: 100%; object-fit: cover; } .card-thumbnail.loading { background: #333; } .card-thumbnail .play-icon { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 3rem; color: rgba(255, 255, 255, 0.8); transition: transform 0.2s ease; } .resource-card:hover .play-icon { transform: translate(-50%, -50%) scale(1.1); } .card-content { padding: 1rem; flex-grow: 1; } .card-content h3 { margin: 0 0 0.5rem; font-size: 1rem; color: var(--text-color); } .card-controls { display: flex; justify-content: space-between; align-items: center; margin-top: 0.75rem; padding-top: 0.5rem; border-top: 1px solid var(--card-border-color); font-size: 0.8rem; } .control-item { display: flex; align-items: center; gap: 0.4rem; }
        .empty-state a:hover {
            text-decoration: underline;
        }
        /* --- Progress Bar Styles --- */
        .progress-bar-container { background-color: var(--card-border-color); border-radius: 20px; overflow: hidden; height: 20px; margin-bottom: 0.5rem; }
        .progress-bar { background-color: var(--primary-color); height: 100%; width: 0; border-radius: 20px; transition: width 0.5s ease-in-out; }
        .progress-text { text-align: right; font-weight: bold; color: var(--text-color); }
        .progress-summary {
            background-color: var(--card-background);
            border: 1px solid var(--card-border-color);
            border-radius: 12px;
            padding: 1.5rem;
        }
        /* --- Modal Styles --- */
        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); justify-content: center; align-items: center; }
        .modal.show { display: flex; }
        .modal-content { position: relative; width: 90%; max-width: 850px; }
        .close-button { position: absolute; top: -30px; right: 0; color: #fff; font-size: 35px; font-weight: bold; cursor: pointer; }
        .close-button:hover, .close-button:focus { color: var(--primary-color); text-decoration: none; }
        .video-container { position: relative; padding-bottom: 56.25%; height: 0; }
        .video-container iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }

    </style>
</head>
<body>
    <main class="main-container">
        <div class="back-to-home">
            <a href="/home.html">← Back to Home</a>
        </div>
        <div class="page-header">
            <h1>My Dashboard</h1>
            <p>Your progress, favorites, and recently watched videos.</p>
        </div>

        <!-- Overall Progress Section -->
        <section class="dashboard-section">
            <h2>Overall Progress</h2>
            <div class="progress-summary">
                <div class="progress-bar-container">
                    <div id="progressBar" class="progress-bar"></div>
                </div>
                <p id="progressText" class="progress-text">Calculating...</p>
            </div>
        </section>

        <!-- Recently Watched Section -->
        <section class="dashboard-section">
            <h2>Recently Watched</h2>
            <div id="recentGrid" class="grid-container" style="grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));">
                <!-- Recently watched videos will be populated here -->
            </div>
            <div id="recentEmpty" class="empty-state" style="display: none;">
                <p>You haven't watched any videos yet. <a href="/home.html">Start learning now!</a></p>
            </div>
        </section>

        <!-- Favorites Section -->
        <section class="dashboard-section">
            <h2>My Favorites</h2>
            <div id="favoritesGrid" class="grid-container" style="grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));">
                <!-- Favorite videos will be populated here -->
            </div>
            <div id="favoritesEmpty" class="empty-state" style="display: none;">
                <p>You haven't favorited any videos yet. Look for the ⭐ icon on video cards.</p>
            </div>
        </section>

    </main>

    <!-- The Modal -->
    <div id="videoModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal()">&times;</span>
            <div class="video-container">
                <iframe id="videoPlayer" src="" title="Video Player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; fullscreen" allowfullscreen></iframe>
            </div>
        </div>
    </div>

    <script>
        // --- Safe Storage & User ID ---
        const safeStorage = (() => {
            try {
                const storage = window.localStorage;
                storage.setItem('__test__', '1'); storage.removeItem('__test__');
                return storage;
            } catch (e) {
                const memoryStore = {};
                return { setItem: (k, v) => { memoryStore[k] = v; }, getItem: (k) => memoryStore[k] || null, removeItem: (k) => { delete memoryStore[k]; } };
            }
        })();

        const userId = safeStorage.getItem('sessionToken');
        let userData = { progress: {}, favorites: [] };

        // --- Dashboard Population ---
        document.addEventListener('DOMContentLoaded', async () => {
            if (!userId) {
                window.location.replace('/login.html');
                return;
            }

            try {
                // This is a placeholder. In a real app, you'd fetch user data.
                // For this demo, we'll assume the data is in npoint.
                const response = await fetch('https://api.npoint.io/628bf2833503e69fb337');
                const users = await response.json();
                const currentUser = users.find(u => u.contactInfo === userId);
                userData = currentUser || { progress: {}, favorites: [] };

                // --- This is a placeholder for total video counts per exam ---
                // In a real app, this data would come from a database or a shared config file.
                const totalVideosPerExam = { upsc: 250, cds: 150, nda: 150, 'ssc-cgl': 75, banking: 100, railways: 100 };

                // Get the user's primary exam to show relevant stats
                const userExam = safeStorage.getItem('userExamChoice') || 'upsc';

                // Populate Favorites
                const favoritesGrid = document.getElementById('favoritesGrid');
                const favoriteVideos = userData.favorites ? (userData.favorites[userExam] || []) : [];
                if (favoriteVideos.length > 0) {
                    favoriteVideos.forEach(video => favoritesGrid.appendChild(createVideoCard(video)));
                } else {
                    document.getElementById('favoritesEmpty').style.display = 'block';
                }

                // Populate Recently Watched (from sessionStorage for simplicity)
                const recentGrid = document.getElementById('recentGrid');
                const recentVideosJson = window.sessionStorage.getItem('recentlyWatched');
                const recentVideos = recentVideosJson ? JSON.parse(recentVideosJson) : [];
                if (recentVideos.length > 0) {
                    recentVideos.forEach(video => recentGrid.appendChild(createVideoCard(video)));
                } else {
                     document.getElementById('recentEmpty').style.display = 'block';
                }

                // Populate Progress Bar
                const totalVideos = totalVideosPerExam[userExam] || 0;
                const completedVideosForExam = userData.progress ? (userData.progress[userExam] || {}) : {};
                const completedCount = Object.keys(completedVideosForExam).length;
                const percentage = totalVideos > 0 ? Math.round((completedCount / totalVideos) * 100) : 0;

                const progressBar = document.getElementById('progressBar');
                const progressText = document.getElementById('progressText');

                // Animate the progress bar
                setTimeout(() => {
                    progressBar.style.width = `${percentage}%`;
                }, 100); // Small delay for animation to be visible
                progressText.textContent = `${percentage}% Complete (${completedCount} / ${totalVideos} videos)`;

            } catch (error) {
                console.error('Error loading dashboard:', error);
                document.getElementById('favoritesEmpty').style.display = 'block';
                document.getElementById('recentEmpty').style.display = 'block';
            }
        });

        function createVideoCard(video) {
            const card = document.createElement('div');
            card.className = 'resource-card'; // Use the same class as video-page.js
            const userExam = safeStorage.getItem('userExamChoice') || 'upsc';
            const isCompleted = userData.progress && userData.progress[userExam] && userData.progress[userExam][video.id];

            const thumbnailUrl = video.type === 'gdrive' 
                ? 'https://images.unsplash.com/photo-1598257006624-980a25028048?q=80&w=2070' 
                : `https://img.youtube.com/vi/${video.id}/mqdefault.jpg`;

            card.innerHTML = `
                <div class="card-thumbnail loading">
                    <img src="${thumbnailUrl}" alt="${video.title}">
                    <span class="play-icon">▶</span>
                </div>
                <div class="card-content">
                    <h3>${video.title}</h3>
                    <div class="card-controls">
                        <div class="control-item">
                            <input type="checkbox" id="progress-${video.id}" class="progress-checkbox" ${isCompleted ? 'checked' : ''} disabled>
                            <label for="progress-${video.id}">Completed</label>
                        </div>
                    </div>
                </div>
            `;
            // The onclick event is disabled to prevent video popups on the dashboard.
            // The card is no longer clickable.
            card.style.cursor = 'default';

            return card;
        }

        // --- Modal Functions (Simplified) ---
        const modal = document.getElementById('videoModal');
        const videoPlayer = document.getElementById('videoPlayer');
        function openModal(video) {
            videoPlayer.src = `https://www.youtube.com/embed/${video.id}?autoplay=1`;
            modal.classList.add('show');
        }
        function closeModal() {
            modal.classList.remove('show');
            videoPlayer.src = "";
        }
        window.onclick = (event) => { if (event.target == modal) closeModal(); };
    </script>
</body>
</html>