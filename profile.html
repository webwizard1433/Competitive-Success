<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Profile | Competitive Success</title>
    <link rel="icon" href="/success.png" type="image/png">
    <style>
        /* --- "Cosmic Gold" Theme (from home.html) --- */
        :root { --primary-color: #FFC107; --primary-hover-color: #DAA520; --card-background: rgba(255, 255, 255, 0.05); --card-border-color: rgba(255, 255, 255, 0.2); --text-color: #F5F5DC; --secondary-text-color: #adb5bd; --error-color: #e03131; --success-color: #2f9e44; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #0a192f;
            background-image: radial-gradient(at 80% 20%, hsla(212,40%,50%,0.3) 0px, transparent 50%), radial-gradient(at 20% 80%, hsla(280,40%,50%,0.3) 0px, transparent 50%);
            margin: 0; color: var(--text-color); min-height: 100vh; background-attachment: fixed;
        }
        .main-container { padding: 2rem; max-width: 1200px; margin: auto; width: 100%; box-sizing: border-box; }
        .page-header { text-align: center; margin-bottom: 2.5rem; }
        .page-header h1 { font-size: 3rem; color: var(--primary-color); margin: 0; }
        .page-header p { font-size: 1.2rem; color: var(--secondary-text-color); }
        .back-to-home { margin-bottom: 1.5rem; }
        .back-to-home a { display: inline-block; padding: 0.5rem 1rem; background-color: var(--card-background); border: 1px solid var(--card-border-color); color: var(--primary-color); text-decoration: none; font-weight: bold; border-radius: 5px; transition: background-color 0.3s ease; }
        .back-to-home a:hover { background-color: rgba(255, 255, 255, 0.1); }
        .profile-container {
            background-color: var(--card-background);
            border: 1px solid var(--card-border-color);
            border-radius: 12px;
            padding: 2rem;
            max-width: 700px;
            margin: 2rem auto;
        }
        .form-group {
            margin-bottom: 1.5rem;
        }
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--secondary-text-color);
            font-weight: 600;
        }
        .form-group input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(0,0,0,0.2);
            color: var(--text-color);
            border-radius: 5px;
            box-sizing: border-box;
            font-size: 1rem;
        }
        .form-group input:focus {
            outline: none;
            border-color: var(--primary-color);
        }
        /* --- Password Strength Meter --- */
        .strength-meter {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }
        .strength-meter div {
            flex: 1;
            height: 5px;
            background-color: var(--card-border-color);
            border-radius: 5px;
            transition: background-color 0.3s ease;
        }
        .strength-meter div.weak { background-color: #e03131; }
        .strength-meter div.medium { background-color: #fcc419; }
        .strength-meter div.strong { background-color: #2f9e44; }
        .btn {
            display: inline-block;
            padding: 0.75rem 1.5rem;
            background-color: var(--primary-color); 
            color: #000000;
            border: none;
            border-radius: 5px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        .btn:hover {
            background-color: var(--primary-hover-color);
        }
        .btn-danger {
            background-color: transparent;
            color: var(--error-color);
            border: 1px solid var(--error-color);
            margin-left: 1rem;
        }
        .btn-danger:hover {
            background-color: rgba(224, 49, 49, 0.1);
            color: #ff6b6b;
        }
        .message {
            text-align: center;
            margin-top: 1rem;
            padding: 0.75rem;
            border-radius: 5px;
            display: none;
        }        
        .message.success { background-color: rgba(47, 158, 68, 0.1); color: #2f9e44; display: block; }
        .message.error { background-color: rgba(224, 49, 49, 0.1); color: #e03131; display: block; }
    </style>
    <style>
        /* Style for dropdown options */
        #examChoice option {
            background: var(--card-background);
            color: var(--text-color);
        }
    </style>
</head>
<body>
    <main class="main-container">
        <div class="back-to-home">
            <a href="/home.html">‚Üê Back to Dashboard</a>
        </div>
        <div class="page-header">
            <h1>My Profile</h1>
            <p>View and update your account details.</p>
        </div>

        <div class="profile-container">
            <form id="profileForm">
                <div class="form-group">
                    <label for="fullName">Full Name</label>
                    <input type="text" id="fullName" readonly style="background-color: rgba(0,0,0,0.4); cursor: not-allowed;">
                </div>
                <div class="form-group">
                    <label for="contactInfo">Email or Mobile Number</label>
                    <input type="text" id="contactInfo" readonly style="background-color: rgba(0,0,0,0.4); cursor: not-allowed;">
                </div>
                <div class="form-group">
                    <label for="password">New Password (optional)</label>
                    <input type="password" id="password" placeholder="Leave blank to keep current password">
                    <div class="strength-meter" id="password-strength-meter">
                        <div></div><div></div><div></div><div></div>
                    </div>
                </div>

                <button type="submit" class="btn">Save Changes</button>
                <button type="button" id="deleteAccountBtn" class="btn btn-danger">Delete Account</button>
                <div id="message" class="message"></div>
            </form>
        </div>
    </main>

    <script>
        // Note: This is a simplified list. A real app might fetch this from a config.
        const exams = { upsc: "UPSC", cds: "CDS", nda: "NDA", 'ssc-cgl': "SSC-CGL", banking: "Banking", railways: "Railways" };

        const safeStorage = (() => {
            try {
                const storage = window.localStorage;
                storage.setItem('__test__', '1');
                storage.removeItem('__test__');
                return storage;
            } catch (e) {
                const memoryStore = {};
                return { setItem: (k, v) => { memoryStore[k] = v; }, getItem: (k) => memoryStore[k] || null, removeItem: (k) => { delete memoryStore[k]; } };
            }
        })();

        const userId = safeStorage.getItem('sessionToken');
        const form = document.getElementById('profileForm');
        const contactInfoInput = document.getElementById('contactInfo');
        const fullNameInput = document.getElementById('fullName');
        const messageDiv = document.getElementById('message');
        const passwordInput = document.getElementById('password');
        const strengthMeter = document.getElementById('password-strength-meter');
        const strengthMeterBars = strengthMeter.querySelectorAll('div');

        passwordInput.addEventListener('input', () => {
            const password = passwordInput.value;
            let score = 0;
            if (!password) { // Hide meter if input is empty
                strengthMeterBars.forEach(bar => bar.className = '');
                return;
            }
            if (password.length >= 8) score++;
            if (/[A-Z]/.test(password)) score++;
            if (/[a-z]/.test(password)) score++;
            if (/[0-9]/.test(password)) score++;
            if (/[^A-Za-z0-9]/.test(password)) score++;

            strengthMeterBars.forEach((bar, index) => {
                if (index < score) {
                    if (score <= 2) bar.className = 'weak';
                    else if (score <= 4) bar.className = 'medium';
                    else bar.className = 'strong';
                } else { bar.className = ''; }
            });
        });

        document.addEventListener('DOMContentLoaded', async () => {
            if (!userId) {
                window.location.replace('/login.html');
                return;
            }

            // Fetch all users to find the current one (insecure demo method)
            try {
                const response = await fetch('https://api.npoint.io/628bf2833503e69fb337');
                const users = await response.json();
                const currentUser = users.find(u => u.contactInfo === userId);

                if (currentUser) {
                    contactInfoInput.value = currentUser.contactInfo;
                    fullNameInput.value = (currentUser.fullName && currentUser.fullName !== 'undefined') ? currentUser.fullName : 'User';
                }
            } catch (error) {
                messageDiv.textContent = 'Failed to load profile data.';
                messageDiv.className = 'message error';
            }

            // Dynamically set the back link
            const backLink = document.querySelector('.back-to-home a');
            if (backLink) backLink.href = `/home.html`;
        });

        // Add a pageshow event listener to re-check authentication
        // This prevents users from accessing the page via browser back/forward after logout
        window.addEventListener('pageshow', function(event) {
            if (!userId) { // userId is derived from safeStorage
                window.location.href = '/login.html';
            }
        });

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const npointUrl = 'https://api.npoint.io/628bf2833503e69fb337';
            
            const newPassword = document.getElementById('password').value;

            // Validate password strength only if a new password is provided
            if (newPassword && newPassword.length < 8) {
                messageDiv.textContent = 'New password must be at least 8 characters long.';
                messageDiv.className = 'message error';
                return;
            }

            try {
                // 1. Get the current list of users
                const getResponse = await fetch(npointUrl);
                let users = await getResponse.json();

                // 2. Find and update the current user's data
                const userIndex = users.findIndex(u => u.contactInfo === userId);
                if (userIndex > -1) {
                    users[userIndex].fullName = fullNameInput.value; // Ensure fullName is preserved
                    if (newPassword) {
                        users[userIndex].password = newPassword; // Insecure: for demo only
                    }
                }

                // 3. Post the entire updated list back
                const postResponse = await fetch(npointUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(users)
                });

                if (!postResponse.ok) throw new Error('Failed to save changes.');

                // Update local storage and show success
                safeStorage.setItem('userName', users[userIndex].fullName); // Also update username in case it was missing
                messageDiv.textContent = 'Profile updated successfully!';
                messageDiv.className = 'message success';

            } catch (error) {
                messageDiv.textContent = error.message || 'An error occurred.';
                messageDiv.className = 'message error';
            }
        });

        document.getElementById('deleteAccountBtn').addEventListener('click', async () => {
            const confirmation = confirm("Are you sure you want to delete your account? This action is irreversible.");

            if (!confirmation) {
                return;
            }

            const npointUrl = 'https://api.npoint.io/628bf2833503e69fb337';

            try {
                // 1. Get the current list of users
                const getResponse = await fetch(npointUrl);
                let users = await getResponse.json();

                // 2. Filter out the current user
                const updatedUsers = users.filter(u => u.contactInfo !== userId);

                // 3. Post the updated list back
                const postResponse = await fetch(npointUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updatedUsers)
                });

                if (!postResponse.ok) throw new Error('Failed to delete account.');

                // 4. Log out the user and redirect
                safeStorage.removeItem('sessionToken');
                safeStorage.removeItem('userName');
                safeStorage.removeItem('userExamChoice');
                window.location.replace('/register.html'); // Redirect to registration page

            } catch (error) {
                messageDiv.textContent = error.message || 'An error occurred while deleting the account.';
                messageDiv.className = 'message error';
            }
        });
    </script>
</body>
</html>